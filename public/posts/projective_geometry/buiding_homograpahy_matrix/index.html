<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>üìΩÔ∏è Projective Geometry: Building the Homography Matrix from scratch | I√±aki‚Äôs Log</title>
<meta name="keywords" content="computer vision, projective geometry, homography matrix, pinhole camera">
<meta name="description" content="Table of Contents 1. Pinhole camera model 2. Intrinsic matrix 2.1. Setup 2.2. Homogeneous coordinates 2.3. Accounting for distortions 2.3.1. Digital images 2.3.2. Rephotographing Images 3. Extrinsic matrix 4. Homography matrix 5. References 1. Pinhole camera model When we capture something on camera, there is an interesting phenomenon going on: compression. We are taking a photograph of a 3D world, and capturing it in a 2D image. This 3D‚Üí2D space mapping inevitably leads to information loss.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/projective_geometry/buiding_homograpahy_matrix/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/projective_geometry/buiding_homograpahy_matrix/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js" integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
        ]
    });
});
</script>

</head>

<body class="" id="top">

<head>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X47ZD00R5L"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-X47ZD00R5L', { 'anonymize_ip': false });
}
</script>

</head>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="I√±aki‚Äôs Log (Alt + H)">I√±aki‚Äôs Log</a>
            <div class="logo-switches">
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="üìö Posts">
                    <span>üìö Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="üè∑Ô∏è Tags">
                    <span>üè∑Ô∏è Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="üîç Search (Alt &#43; /)" accesskey=/>
                    <span>üîç Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="üëã About">
                    <span>üëã About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      üìΩÔ∏è Projective Geometry: Building the Homography Matrix from scratch
    </h1>
    <div class="post-meta"><span title='2023-04-05 11:16:19 +0100 +0100'>April 5, 2023</span>

</div>
  </header> 
  <div class="post-content"><span style="background-color: lightgrey; border: 1px solid black; padding: 2px 10px; display: inline-flex; align-items: center;">
  <details>
    <summary><strong>Table of Contents</strong></summary>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#1-pinhole-camera-model">1. Pinhole camera model</a></li>
    <li><a href="#2-intrinsic-matrix">2. Intrinsic matrix</a>
      <ul>
        <li><a href="#21-setup">2.1. Setup</a></li>
        <li><a href="#22-homogeneous-coordinates">2.2. Homogeneous coordinates</a></li>
        <li><a href="#23-accounting-for-distortions">2.3. Accounting for distortions</a>
          <ul>
            <li><a href="#231-digital-images">2.3.1. Digital images</a></li>
            <li><a href="#232-rephotographing-images">2.3.2. Rephotographing Images</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3-extrinsic-matrix">3. Extrinsic matrix</a></li>
    <li><a href="#4-homography-matrix">4. Homography matrix</a></li>
    <li><a href="#5-references">5. References</a></li>
  </ul>
</nav>
  </details>
</span>
<h1 id="1-pinhole-camera-model">1. Pinhole camera model<a hidden class="anchor" aria-hidden="true" href="#1-pinhole-camera-model">#</a></h1>
<p>When we capture something on camera, there is an interesting phenomenon going on: <strong>compression</strong>. We are taking a photograph of a 3D world, and capturing it in a 2D image. This 3D‚Üí2D space mapping inevitably leads to information loss. There are multiple locations in the 3D world that project exactly to the same position in the 2D image. Nonetheless, this observation should not come as a surprise to anyone: it is precisely the reason occlusions take place. Multiple objects at different places end up in the same location when viewed through a 2D projection, be it a film or our retina.</p>
<p>So how do we model that 3D‚Üí2D mapping? That is what projective geometry is all about. To understand this transform, let us start with the ideal <strong>pinhole camera model</strong>, illustrated below:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Ovni1.png" alt="Ovni flying above the camera" width="30%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Example of an analogic camera (cube at the bottom) pointing upwards to capture an ovni flying above it.</figcaption>
</figure>
<p>In this setup, the camera consists of a simple dark box with a small aperture (termed <strong>pinhole</strong>), located in its front, and a film on its rear wall, with dimensions <strong>(W, H)</strong>. The distance between the pinhole and the film is known as the <strong>focal length (f)</strong>.</p>
<p>The image is formed when the light rays enter it through the pinhole (which we will assume of infinitesimal radius) and are captured by the photographic material the film is composed of. This way, an inverted image is obtained, which can be flipped in a post-processing step. Moreover, this is equivalent to forming a virtual image in front of the camera, at a distance <strong>f</strong> from the pinhole.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Ovni2.png" alt="Virtual image formation" width="30%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Example of virtual inverted image formation. The light rays project to the film located at the back of the analogic camera, causing an inversion. In order to undo the inversion, we can flip the formed image, which is equivalent to capturing a virtual image in a plane in front of the film.</figcaption>
</figure>
<h1 id="2-intrinsic-matrix">2. Intrinsic matrix<a hidden class="anchor" aria-hidden="true" href="#2-intrinsic-matrix">#</a></h1>
<h2 id="21-setup">2.1. Setup<a hidden class="anchor" aria-hidden="true" href="#21-setup">#</a></h2>
<p>In order to characterize the projection, let us start by defining the two system of coordinates involved in the transform:</p>
<ul>
<li><strong>3D World</strong>: we define the origin of coordinates located at the camera pinhole. Furthermore, the cartesian axes will also be aligned with the camera axes.</li>
<li><strong>2D Image</strong>: we define the origin of coordinates located at the bottom-left corner of the virtual image.</li>
</ul>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Ovni3.png" alt="Coordinate systems" width="30%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Illustration of the two different coordinates systems: the world coordinate system, centered at the camera pinhole (<strong><span style="color: pink;">pink</span></strong>) and the image coordinate system, centered at the bottom left corner of the virtual image (<strong><span style="color: red;">red</span></strong>).</figcaption>
</figure>
<p>Given these arbitrary definitions, we can now determine where a point $p=(x, y, z)$ will be projected in the image. To do so, we just need to recall that the projection $P=(X, Y)$ is found at the intersection between the plane containing the virtual image, and the ray passing through both the point p and the pinhole $o=(0, 0, 0)$.</p>
<p>For simplicity, let us focus on how the projection takes place for the horizontal dimension $x$:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/TriangleSimilarity1.png" alt="Triangle similarity" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Left image shows how a a 3D point $\vec{p}$ is projected into the virtual image at pixel $\vec{P}$. Right image focuses on the <strong>ZX</strong> plane.</figcaption>
</figure>
<p>We can observe that there are two similar triangles (black and green) on the right image. Therefore, the rate between the lengths of their sides is preserved:</p>
<p>$$
\begin{equation}\frac{z}{x} = \frac{f}{X-\frac{W}{2}}\end{equation}
$$</p>
<p>or equivalently</p>
<p>$$
\begin{equation}f\cdot x+\frac{W}{2}\cdot z=X \cdot z\end{equation}
$$</p>
<p>We can derive the projection along the y dimension in an analogous fashion, resulting in:</p>
<p>$$
\begin{equation}f\cdot y+\frac{H}{2}\cdot z=Y \cdot z\end{equation}
$$</p>
<h2 id="22-homogeneous-coordinates">2.2. Homogeneous coordinates<a hidden class="anchor" aria-hidden="true" href="#22-homogeneous-coordinates">#</a></h2>
<p>At this point, it is worth wondering: can we express the previous equations as a matrix product?</p>
<p>$$
\begin{equation}
\begin{bmatrix}
f &amp; 0 &amp; \frac{W}{2}\\
0 &amp; f &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix} =
\begin{bmatrix}
X\cdot z \\
Y\cdot z \\
z
\end{bmatrix}
\end{equation}
$$</p>
<p>It is almost what we want, but we have an extra scaling factor on the right hand-side</p>
<p>$$
\begin{equation}
\begin{bmatrix}
f &amp; 0 &amp; \frac{W}{2}\\
0 &amp; f &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix} = z\cdot \begin{bmatrix}
X \\
Y \\
1
\end{bmatrix}
\end{equation}
$$</p>
<p>And here is where <strong>homogeneous coordinates</strong> show up. For a point $\vec{P}=[X,Y]^T$, its homogeneous coordinates can be defined as</p>
<p>$$
\begin{equation}
\vec{P_H}=\begin{bmatrix}
s\cdot X \\
s\cdot Y \\
s
\end{bmatrix} = s\cdot \begin{bmatrix}
X \\
Y \\
1
\end{bmatrix}
\end{equation}
$$</p>
<p>Leveraging this definition, we can express the projection as</p>
<p>$$
\begin{equation}K\cdot \vec{p}=\vec{P}_H
\end{equation}
$$</p>
<p>where $K$ is defined as the intrinsic matrix</p>
<p>$$
\begin{equation}
K=\begin{bmatrix}
f &amp; 0 &amp; \frac{W}{2}\\
0 &amp; f &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<p>and $\vec{p}$ corresponds to the 3D world point</p>
<p>$$
\begin{equation}
\vec{p}=\begin{bmatrix}
x\\
y\\
z
\end{bmatrix}
\end{equation}
$$</p>
<p>ImportantIy, homogenous coordinates are defined up to a scale. Why is that the case? Going back to the introduction, we stated that there was a compression involved in projective geometry. We are capturing a 3D world into a 2D image. That implies that there is an infinite set of aligned points (i.e. a line) in the 3D world that are mapped exactly to the same location in image space. Take a look at the image below</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/TriangleSimilarity2.png" alt="Projective compression" width="30%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Illustration of the compression that occurs when projecting points from the 3D world into a 2D image. All points that belong to a ray going through the pinhole, such as $\vec{p}$ and $\vec{p'}$ are mapped to the same pixel.</figcaption>
</figure>
<p>Once again, due to the similarity of the triangles involved, we know that</p>
<p>$$
\begin{equation}\frac{z}{z&rsquo;} = \frac{x}{x&rsquo;} = \frac{y}{y&rsquo;} = s
\end{equation}
$$</p>
<p>If we plug in our matrix equation both $\vec{p}$ and $\vec{p&rsquo;}$, we will obtain</p>
<p>$$
\begin{equation}
\vec{P_H}=\begin{bmatrix}
f\cdot x + \frac{W}{2}\cdot z \\
f\cdot y + \frac{H}{2}\cdot z \\
z
\end{bmatrix}
\end{equation}
$$</p>
<p>and</p>
<p>$$
\begin{equation}
\vec{P_H}&rsquo;=\begin{bmatrix}
f\cdot x&rsquo; + \frac{W}{2}\cdot z&rsquo; \\
f\cdot y&rsquo; + \frac{H}{2}\cdot z&rsquo; \\
z&rsquo;
\end{bmatrix}
\end{equation}
$$</p>
<p>It is clear these two vectors are not the same. However, they are proportional</p>
<p>$$
\begin{equation}
\vec{P_H}&rsquo;=s\cdot\vec{P_H}
\end{equation}
$$</p>
<p>Consequently, in homogeneous coordinates, they represent exactly the same point in image space! And how do we obtain its image coordinates $\vec{P}=[X,Y]^T$? Following the definition in eq.(6), we simply need to divide by the scale factor encoded in the last dimension:</p>
<p>$$
\begin{equation}
X=\frac{{P_H}_x}{{P_H}_z}
\end{equation}
$$</p>
<p>$$
\begin{equation}
Y=\frac{{P_H}_y}{{P_H}_z}
\end{equation}
$$</p>
<h2 id="23-accounting-for-distortions">2.3. Accounting for distortions<a hidden class="anchor" aria-hidden="true" href="#23-accounting-for-distortions">#</a></h2>
<h3 id="231-digital-images">2.3.1. Digital images<a hidden class="anchor" aria-hidden="true" href="#231-digital-images">#</a></h3>
<p>So far, we have assumed we had an analog camera, so the image coordinates lived in a continuous space. However, most often we deal with digital images. Since the information needs to be stored in bits, we need to both discretize the locations at which we sample the image, and quantitize the values we measure.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Wave.png" alt="Discretization and Quantization" width="30%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Illustration of the effects of sampling along the temporal dimension and quantizing the measured signal amplitud.</figcaption>
</figure>
<p>Since we are focused on the spatial mapping, the effect we care about is the <strong>discretization</strong> that takes place in the projected image. If we use squared pixels, we will get something as displayed below:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Discretization.png" alt="2D Discretization" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Depiction of the effects of capturing a real world object (left) as a 2D digital image, which only allows to store a discrete number of values at a discrete set of 2D pixel locations.</figcaption>
</figure>
<p>The length of the pixel side is given by the width (height) of the image divided by the number of pixels along the corresponding dimension $N_x$ ($N_y$):</p>
<p>$$
\begin{equation}
\Delta=\frac{W}{N_x}=\frac{H}{N_y}
\end{equation}
$$</p>
<p>We can now express the image coordinates using the pixel length as its units. That is to say, both the image dimensions and the focal length can be defined in pixels:</p>
<p>$$
\begin{equation}
f=f_I\cdot\Delta,\;\;\;\;\;\;\;\;
W=W_I\cdot\Delta,\;\;\;\;\;\;\;\;
H=H_I\cdot\Delta
\end{equation}
$$</p>
<p>As a result, if we want to obtain the projected coordinates in this discretized image space, we simply need to tweak slightly our intrinsic matrix:</p>
<p>$$
\begin{equation}
K=\begin{bmatrix}
\frac{f}{\Delta} &amp; 0 &amp; \frac{W}{2\Delta}\\
0 &amp; \frac{f}{\Delta} &amp; \frac{H}{2\Delta}\\
0 &amp; 0 &amp; 1
\end{bmatrix} =
\begin{bmatrix}
f_I &amp; 0 &amp; \frac{W_I}{2}\\
0 &amp; f_I &amp; \frac{H_I}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<p>So what happens if instead we have non-squared pixels?</p>
<p>$$
\begin{equation}
\Delta_x = r\cdot\Delta_y
\end{equation}
$$</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/DiscretizationRectangular.png" alt="2D Recangular Discretization" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Effect of using rectangular (non-squared) pixels for the 2D digital image that captures the real world object.</figcaption>
</figure>
<p>Well, that is how we end up with two different focal lengths along each dimension:</p>
<p>$$
\begin{equation}
W=W_I\cdot\Delta_x
\end{equation}
$$</p>
<p>$$
\begin{equation}
H=H_I\cdot\Delta_y
\end{equation}
$$</p>
<p>$$
\begin{equation}
f=f{_I}_x\cdot\Delta_x
\end{equation}
$$</p>
<p>$$
\begin{equation}
f=f{_I}_y\cdot\Delta_y
\end{equation}
$$</p>
<p>which leads to the common definition of the intrinsic matrix (we have dropped the subindex $I$ for ease of notation)</p>
<p>$$
\begin{equation}
K=\begin{bmatrix}
f_x &amp; 0 &amp; \frac{W}{2}\\
0 &amp; f_y &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<h3 id="232-rephotographing-images">2.3.2. Rephotographing Images<a hidden class="anchor" aria-hidden="true" href="#232-rephotographing-images">#</a></h3>
<p>It is common to see an additional parameter in the intrinsic matrix: the <strong>skew</strong> factor. It accounts for a shearing effect, i.e., image axes not being perpendicular, which results in non-rectangular parallelogrammatic pixels.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/DiscretizationShearing.png" alt="Shearing Distortion" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Effect of shearing distortion when capturing a real world object in a 2D digital image.</figcaption>
</figure>
<p>Mathematically, it can be modelled by a simple change of basis. Therefore, we just need to find the coefficients of the point expressed in the new basis. Using trigonometry, we can derive.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/Shearing.png" alt="Shearing" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Detailed depiction of the trigonometry involved in the shearing distortion that maps a squared pixel (<strong><span style="color: pink;">pink</span></strong>) to a rhomboid one (<strong><span style="color: green;">green</span></strong>).</figcaption>
</figure>
<p>Using trigonometry, we can derive</p>
<p>$$
\begin{equation}
\cos(90-\varphi)=\sin(\varphi)=\frac{y}{y&rsquo;} \; \; \;\rightarrow \; y&rsquo;=\frac{y}{\sin(\varphi)}
\end{equation}
$$</p>
<p>$$
\begin{equation}
\sin(90-\varphi)=\cos(\varphi)=\frac{x&rsquo;-x}{y&rsquo;} \; \; \;\rightarrow \; x&rsquo; = x - y&rsquo;\cdot \cos(\varphi)
\end{equation}
$$</p>
<p>and combining both equations</p>
<p>$$
\begin{equation}
x&rsquo; = x - y\cdot\cos(\varphi) / \sin(\varphi) = x - y\cdot\cot(\varphi)
\end{equation}
$$</p>
<p>or in matrix form</p>
<p>$$
\begin{equation}\begin{bmatrix}
x&rsquo; \\
y&rsquo;
\end{bmatrix}
=\begin{bmatrix}
1 &amp; -\cot(\varphi) \\
0 &amp; \frac{1}{\sin(\varphi)}
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y
\end{bmatrix}
\end{equation}
$$</p>
<p>Overall, there is a nice way to decouple the different transforms we have discussed so far:</p>
<ol>
<li>
<p>Scaling: projecting 3D world into 2D image</p>
<p>$$
\begin{equation}
\begin{bmatrix}
f_x &amp; 0 &amp; 1\\
0 &amp; f_y &amp; 1\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
</li>
<li>
<p>Shearing: accounting for non-perpendicular axes</p>
<p>$$
\begin{equation}
\begin{bmatrix}
1 &amp; -\cot(\varphi) &amp; 0\\
0 &amp; \frac{1}{\sin(\varphi)} &amp; 0\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
</li>
<li>
<p>Shift: to move the origin of the image space to the bottom-left of the image.</p>
<p>$$
\begin{equation}\begin{bmatrix}
1 &amp; 0 &amp; \frac{W}{2}\\
0 &amp; 1 &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
</li>
</ol>
<p>which overall results in the following intrinsic matrix</p>
<p>$$
\begin{equation}K&rsquo; =\begin{bmatrix}
1 &amp; 0 &amp; \frac{W}{2}\\
0 &amp; 1 &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot
\begin{bmatrix}
1 &amp; -\cot(\varphi) &amp; 0\\
0 &amp; \frac{1}{\sin(\varphi)} &amp; 0\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot
\begin{bmatrix}
f_x &amp; 0 &amp; 1\\
0 &amp; f_y &amp; 1\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<p>It can be reduced to</p>
<p>$$
\begin{equation}
K&rsquo;=\begin{bmatrix}
f_x &amp; -f_x\cdot\cot(\varphi) &amp; \frac{W}{2}\\
0 &amp; \frac{f_y}{\sin(\varphi)} &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<p>or how it is more often presented:</p>
<p>$$
\begin{equation}
K&rsquo;=\begin{bmatrix}
f_x &amp; s &amp; \frac{W}{2}\\
0 &amp; f_y &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\end{equation}
$$</p>
<p>Notice how it is fully characterised with 5 parameters: the focal length along both dimensions $(f_x, f_y)$, the skew factor $s$ and the image size $(W, H)$.</p>
<p>It is worth pointing out that in most cases, the shearing effect is not present. It is very unlikely that a camera is flawed to the point of not having its axes perpendicular. However, it can arise when a picture is retaken and the film of the second camera is not parallel with the image.</p>
<h1 id="3-extrinsic-matrix">3. Extrinsic matrix<a hidden class="anchor" aria-hidden="true" href="#3-extrinsic-matrix">#</a></h1>
<p>So far, we have assumed our arbitrarily world coordinate system (pink) is perfectly aligned with our camera coordinate system (green), with its origin at the camera pinhole and its Cartesian axes parallel to the camera axes.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/OvniRotation.png" alt="Ovni flying above the camera" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Illustration of a shift and rotation of the camera w.r.t. the world coordinate system (<strong><span style="color: pink;">pink</span></strong>). It allows us to define an additional camera coordinate system (<strong><span style="color: green;">green</span></strong>) centered at the camera pinhola and aligned with the camera plane.</figcaption>
</figure>
<p>However, when we take photos of videos in the world, we often rotate and/or shift the camera. This results in a camera system that can be derived from the world system by applying two steps sequentially:</p>
<ol>
<li>
<p>Rotate the axes by:</p>
<p>$$
R(\varphi_x,\varphi_y,\varphi_z)\equiv R
$$</p>
</li>
<li>
<p>Shift the origin by</p>
<p>$$
t\vec{}=\begin{bmatrix}
t_x \\
t_y \\
t_z
\end{bmatrix}
$$</p>
</li>
</ol>
<p>These two parameters $(R, \vec{t})$ define the <strong>camera pose</strong>.</p>
<p>In such a scenario, it might be convenient to have a static coordinate system as a reference, which the camera does not provide anymore. Consequently, it is worth considering: how can we define mathematically the camera projection under these circumstances?</p>
<p>In order to account for this misalignment, it is useful to understand how we can map the coordinates between both coordinate systems. To better understand how that is done, let us simplify to 2D, as depicted in the following figure:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/ChangeOfBasis1.png" alt="Change of Basis" width="60%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Example of two different coordinate systems, <strong><span style="color: pink;">pink</span></strong> one being rotated and shifted w.r.t. to <strong><span style="color: pink;">pink</span></strong> one. A point can be expressed in both of them as <strong><span style="color: green;">$\vec{p'}$</span></strong> and <strong><span style="color: pink;">$\vec{p}$</span></strong> respectively.</figcaption>
</figure>
<p>The origin of coordinates in the camera system is located at $\vec{t}=[t_x,t_y]$ w.r.t. the world system. Following this observation, we can infer that in order to align both origin of coordinates $O$ and $O&rsquo;$, we just need to apply a shift given by the vector $\vec{t}$:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/ChangeOfBasis2.png" alt="Shift" width="45%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">By shifting the camera coordinate system by the vector $\vec{t}$ we can center both system of coordinate systems at the same locatiton.</figcaption>
</figure>
<p>However, we still need to account for the rotation between the axes, given by angle $\varphi$.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/ChangeOfBasis3.png" alt="Rotation" width="45%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">By further rotating the camera coordinate system by angle $\varphi$ we can also align both system of coordinate systems.</figcaption>
</figure>
<p>As we can observe, now both systems are perfectly aligned (notice how we used the equal symbol between $p_3$ and $p&rsquo;$, not just the equivalent symbol). Accordingly, to express a point in the camera system, we just need to apply two steps:</p>
<ol>
<li>
<p>Reverse shift:</p>
<p>$$
\begin{equation}
\vec{p}_2=\vec{p}-\vec{t}
\end{equation}
$$</p>
</li>
<li>
<p>Reverse rotation:</p>
<p>$$
\begin{equation}
\vec{p&rsquo;}=\vec{p}_3=
R^{-1}\cdot\vec{p}_2=
R^T\cdot(\vec{p}-\vec{t})
\end{equation}
$$</p>
<p>where we have exploited the fact that rotation matrices are unitary, so their inverse is equal to their transpose.</p>
</li>
</ol>
<p>It is worth remarking that order matters!. If we were to rotate first, we would not be rotating around $O&rsquo;$ as we would hope to in order to align the camera axes, but around $O$, as illustrated below</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/ChangeOfBasis4.png" alt="Rotation" width="90%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Illustration of why order matters. If we apply first the rotation, and then the shift, both coordinates sistems end up with their axes parallel to each other, but their origin of coordinates misaligned.</figcaption>
</figure>
<p>At this point, it is worth wondering: is there any way we can synthetize the previous equation into a simple matrix product?</p>
<p>$$
\begin{equation}
\vec{p&rsquo;}=
\begin{bmatrix}
x&rsquo; \\
y&rsquo; \\
z&rsquo;
\end{bmatrix} = R^T\cdot \left( \begin{bmatrix}
x \\
y \\
z
\end{bmatrix} - \begin{bmatrix}
t_x \\
t_y \\
t_z
\end{bmatrix}
\right)
\end{equation}
$$</p>
<p>It should not come as a surprise to see homogeneous coordinates come to the rescue once again:</p>
<p>$$
\begin{equation}
\vec{p_H&rsquo;}=\begin{bmatrix}
x&rsquo; \\
y&rsquo; \\
z&rsquo; \\
1
\end{bmatrix} = \left[\; R^T\;\; | \;\;-R^T\cdot\vec{t}\;\;\right ]\cdot \begin{bmatrix}
x \\
y \\
z \\
1
\end{bmatrix}
=\left[\; R^T\;\; | \;\;-R^T\cdot\vec{t}\;\;\right ]\cdot {p_H}
\end{equation}
$$</p>
<p>which allows us to define the extrinsic matrix as</p>
<p>$$
\begin{equation}
E= \left[\; R^T\;\; | \;\;-R^T\cdot\vec{t}\;\;\right ]
\end{equation}
$$</p>
<p>In some texts, you might find an equivalent definition given by</p>
<p>$$
\begin{equation}
E= \left[\; R&rsquo;\;\; | \;\;\vec{T}\;\;\right ]
\end{equation}
$$</p>
<p>where $R&rsquo;=R^T$ and $\vec{T}=-R^T\cdot\vec{t}$.</p>
<p>To sum up, the extrinsic matrix is fully described by 6 parameters: the 3D location of the camera $(t_x, t_y, t_z)$ and its 3 rotation angles $(\varphi_x,\varphi_y,\varphi_z)$ defining its orientation.</p>
<h1 id="4-homography-matrix">4. Homography matrix<a hidden class="anchor" aria-hidden="true" href="#4-homography-matrix">#</a></h1>
<p>In the light of these definitions, we have all the ingredients to build the $3\times 4$ <strong>homography</strong> matrix $H$ we were looking for</p>
<p>$$
\begin{equation}
H=K\cdot E =
\begin{bmatrix}
h_{11} &amp; h_{12} &amp; h_{13} &amp; h_{14}\\
h_{21} &amp; h_{22} &amp; h_{23} &amp; h_{24}\\
h_{31} &amp; h_{32} &amp; h_{33} &amp; h_{34}\\
\end{bmatrix}
\end{equation}
$$</p>
<p>which will allow us to project points from the 3D world into a 2D image</p>
<p>$$
\begin{equation}
\vec{P_H}=H\cdot\vec{p_H}
\end{equation}
$$</p>
<p>or if we expand it</p>
<p>$$
\begin{equation}
s\cdot
\begin{bmatrix}
X \
Y \
1 \
\end{bmatrix}=\begin{bmatrix}
f_x &amp; 0 &amp; \frac{W}{2}\\
0 &amp; f_y &amp; \frac{H}{2}\\
0 &amp; 0 &amp; 1
\end{bmatrix} \cdot
\begin{bmatrix}
r_{11} &amp; r_{12} &amp; r_{13} &amp; T_x\\
r_{21} &amp; r_{22} &amp; r_{23} &amp; T_y\\
r_{31} &amp; r_{32} &amp; r_{33} &amp; T_z\\
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y \\
z \\
1 \
\end{bmatrix}
\end{equation}
$$</p>
<p>From this definition, we can notice that the process is irreversible, since we can not invert a $3\times 4$ matrix. However, the homography transform can also be used to characterize the mapping between two different 2D planes. This arises when we take two photographs of the same scene from different camera angles for instance, as illustrated below:</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/MultiCamera1.png" alt="Multiple camera views" width="70%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">Example of two different 2D views of the same 3D world object captured by two different cameras.</figcaption>
</figure>
<p>So what can we do in this scenario? Remember we have chosen arbitrarily how to define our coordinate systems. Thus, we can rearrange the 3D world coordinate system to conveniently align with one of the images, such that the z-axis is orthogonal to it.</p>
<figure class="figure" style="text-align: center;">
  <img src="/buiding_homograpahy_matrix/MultiCamera2.png" alt="Multiple camera views" width="70%" style="display: block; margin: auto;">
  <figcaption class="caption" style="font-weight: normal; max-width: 80%; margin: auto;">We can choose arbitrary the world coordinate system to match the camera coordinate system of one of them. This way, all the pixels from its captured 2D image correspond to 3D locations with $z=0$ in its camera coordinate system.</figcaption>
</figure>
<p>As a result, all points in the image will have $z=0$,</p>
<p>$$
\begin{equation}
s\cdot
\begin{bmatrix}
X \\
Y \\
1 \\
\end{bmatrix}=
\begin{bmatrix}
h_{11} &amp; h_{12} &amp; h_{13} &amp; h_{14}\\
h_{21} &amp; h_{22} &amp; h_{23} &amp; h_{24}\\
h_{31} &amp; h_{32} &amp; h_{33} &amp; h_{34}\\
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y \\
0 \\
1
\end{bmatrix}
\end{equation}
$$</p>
<p>which allows us to drop the third column in the homography matrix:</p>
<p>$$
\begin{equation}
s\cdot
\begin{bmatrix}
X \\
Y \\
1 \\
\end{bmatrix}=
\begin{bmatrix}
h_{11} &amp; h_{12} &amp; h_{14}\\
h_{21} &amp; h_{22} &amp; h_{24}\\
h_{31} &amp; h_{32} &amp; h_{34}\\
\end{bmatrix} \cdot
\begin{bmatrix}
x \\
y \\
1 \\
\end{bmatrix}
\end{equation}
$$</p>
<p>leading to a $3\times 3$ homography matrix that. Notably, there is no longer a compression since it is a 2D‚Üí2D mapping. Consequently, under certain circumstances (mathematically, this implies $H$will be invertible), this transform can be reversible, allowing to convert back and forth between both images.</p>
<h1 id="5-references">5. References<a hidden class="anchor" aria-hidden="true" href="#5-references">#</a></h1>
<ol>
<li>Richard Hartley and Andrew Zisserman. (2000), Page 143,¬†<em>Multiple View Geometry in Computer Vision</em>, Cambridge University Press.</li>
<li>Wikipedia.¬†<a href="https://en.wikipedia.org/wiki/Pinhole_camera_model">Pinhole camera model</a></li>
<li>Dissecting the Camera Matrix: Parts <a href="https://ksimek.github.io/2012/08/14/decompose/">I</a>, <a href="https://ksimek.github.io/2012/08/22/extrinsic/">II</a>, <a href="https://ksimek.github.io/2013/08/13/intrinsic/">III</a>, by Kyle Simek.</li>
<li><a href="https://blog.immenselyhappy.com/post/camera-axis-skew/">Camera intrinsics: Axis skew</a>, b.y Ashima Athri.</li>
<li><a href="https://blog.zhaoyongsheng.com/2019/12/02/Concepts-Usage-and-Advantages-of-Homogeneous-Coordinates/">Concepts, Properties, and Usage of Homogeneous Coordinates</a>, by Youngshon Zhao</li>
<li><a href="https://towardsdatascience.com/what-are-intrinsic-and-extrinsic-camera-parameters-in-computer-vision-7071b72fb8ec">What are Intrinsic and Extrinsic Camera Parameters in Computer Vision?</a> By Aqeel Anwar</li>
<li><a href="https://towardsdatascience.com/camera-intrinsic-matrix-with-example-in-python-d79bf2478c12">Camera Intrinsic Matrix with Example in Python</a>, by <a href="https://ms-neerajkrishna.medium.com/?source=post_page-----d79bf2478c12--------------------------------">Neeraj Krishna</a></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/computer-vision/">Computer Vision</a></li>
      <li><a href="http://localhost:1313/tags/projective-geometry/">Projective Geometry</a></li>
      <li><a href="http://localhost:1313/tags/homography-matrix/">Homography Matrix</a></li>
      <li><a href="http://localhost:1313/tags/pinhole-camera/">Pinhole Camera</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">I√±aki‚Äôs Log</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script src="/js/figure-numbering.js"></script>
</body>

</html>
